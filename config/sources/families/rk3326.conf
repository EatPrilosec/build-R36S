ARCH=arm64
OFFSET=16
OVERLAY_PREFIX=rk3326
OVERLAY_DIR="/boot/u-boot/overlays"
GOVERNOR="ondemand"
declare -g IMAGE_PARTITION_TABLE="gpt"
declare -g UEFI_FS_LABEL="boot"
declare -g ROOT_FS_LABEL="armbian"
declare -g UEFISIZE=256
declare -g BOOTSIZE=0                        # No separate /boot; instead we have /boot/firmware fat32 partition
declare -g BOOTCONFIG=none                   # We are currently not using U-boot for Raspberry Pi boards
declare -g UEFI_MOUNT_POINT="/boot/u-boot" 	 # mount uefi partition at /boot/firmware

declare -g KERNELSOURCE='https://github.com/EatPrilosec/linux-stable-rk3326.git' 
declare -g KERNELBRANCH='branch:linux-6.12.y-rk3326'
declare -g KERNELPATCHDIR="archive/linux-rk3326-lts"

declare -g KERNEL_TARGET="lts"

declare -g KERNEL_MAJOR_MINOR="6.12"

declare -g LINUXCONFIG="linux-rk3326-lts"
                                         
family_tweaks() {
	
	:

	# if [[ -f $SDCARD/lib/systemd/system/rk3399-bluetooth.service ]]; then

	# 	# install and enable Bluetooth
	# 	chroot_sdcard_apt_get_install rfkill bluetooth bluez bluez-tools
	# 	chroot $SDCARD /bin/bash -c "systemctl --no-reload enable rk3399-bluetooth.service >/dev/null 2>&1"

	# elif [[ -f $SDCARD/lib/systemd/system/sprd-bluetooth.service ]]; then

	# 	# install and enable Bluetooth
	# 	chroot_sdcard_apt_get_install rfkill bluetooth bluez bluez-tools
	# 	chroot $SDCARD /bin/bash -c "systemctl --no-reload enable sprd-bluetooth.service >/dev/null 2>&1"

	# fi

}

function pre_umount_final_image__cp_boot_files() {
	display_alert "installing boot files"
	#todo if BOARD_NAME="R36S"
	local tmpdir startdir bootdest
	startdir="$(pwd)"
	tmpdir="$startdir/tmpdir"
	bootdest="${MOUNT}${UEFI_MOUNT_POINT}"

	[ ! -d "$tmpdir" ] && mkdir "$tmpdir"
	cd "$tmpdir"

	run_host_command_logged git clone "https://github.com/R36S-Stuff/R36S-Multiboot.git" R36S-Multiboot
	run_host_command_logged cp -vfr R36S-Multiboot/commonbootfiles/* "${bootdest}/"
	rm "${bootdest}/setup-ezstorage.sh" || true
	
	run_host_command_logged cp -vf R36S-Multiboot/rocknix/rk3326-gameconsole-r36s.dtb "${bootdest}/"
	run_host_command_logged cp -vfr R36S-Multiboot/rocknix/panels "${bootdest}/"



cat << EOD > "${bootdest}/boot.ini"
odroidgoa-uboot-config

# Boot Arguments
setenv bootargs "mitigations=off root=LABEL=armbian rootwait rw fbcon=rotate:0 quiet splash consoleblank=0"
setenv loadaddr "0x02000000"
setenv initrd_loadaddr "0x01100000"
setenv dtb_loadaddr "0x01f00000"
setenv dtbo_loadaddr "0x01e00000"

load mmc 1:2 \${loadaddr} boot/Image
load mmc 1:2 \${initrd_loadaddr} boot/uInitrd

load mmc 1:2 \${dtb_loadaddr} boot/dtb/rk3326-gameconsole-r36s.dtb

if load mmc 1:1 \${dtbo_loadaddr} overlays/mipi-panel.dtbo
	fdt addr \${dtb_loadaddr}
	fdt resize 8192
	fdt apply \${dtbo_loadaddr}
fi

booti \${loadaddr} \${initrd_loadaddr} \${dtb_loadaddr}
EOD


	cd "$startdir"
	rm -rf "$tmpdir"

}


post_umount_final_image__install_u-boot() {
	display_alert "installing u-boot"
	run_host_command_logged parted -s "${LOOP}" set 1 esp off
	#todo if BOARD_NAME="R36S"
	local ubtmpdir startdir
	startdir="$(pwd)"
	ubtmpdir="$startdir/ubtmpdir"
	[ ! -d "$ubtmpdir" ] && mkdir "$ubtmpdir"
	cd "$ubtmpdir"

	# run_host_command_logged git clone "https://github.com/EatPrilosec/R36S-u-boot-builder.git" u-boot 
	# cd u-boot
	# chmod a+x build-uboot.sh
	# run_host_command_logged ./build-uboot.sh || return 1
	run_host_command_logged wget https://github.com/R36S-Stuff/R36S-u-boot-builder/releases/download/rc1/u-boot-r36s.tar
	mkdir sd_fuse
	
	tar xf u-boot-r36s.tar -C sd_fuse
	cd sd_fuse
	chmod a+x ./sd_fusing.sh 
	sed -i 's|sudo dd|dd|' ./sd_fusing.sh
	run_host_command_logged ./sd_fusing.sh "${LOOP}" || return 1
	
	cd "$startdir"
	rm -rf "$ubtmpdir"
}


